namespace = prison_vore

# Prison Vore Choices
prison_vore.0001 = {
    title = prison_voreTitle.0001
    type = character_event
    desc = prison_voreDesc.0001
    theme = dungeon
    
    immediate = {
        scope:actor = {
            save_scope_as = predator
        }
        scope:recipient = {
            save_scope_as = prey
        }       
    }

    left_portrait = {
        character = scope:predator
        animation = flirtation
    }
    right_portrait = {
        character = scope:prey
        animation = fear
    }
    
    # Oral
    option = {
        name = prison_voreOpt.0001a
        trigger = { global_var:oral_banned = no }
        ai_chance = {
            oral_vore_modifier = yes
        }
        trigger_event = prison_vore.0002 
        hidden_effect = {
            scope:predator = {
                change_variable = { name = num_prey add = 1 }
                update_vore_portrait_effect = yes
            }
        }
    }            
 
    # Anal
    option = {
        name = prison_voreOpt.0001b
        trigger = { global_var:anal_banned = no }
        ai_chance = {
            anal_vore_modifier = yes
        }
        trigger_event = prison_vore.0003 
        hidden_effect = {
            scope:predator = {
                change_variable = { name = num_prey add = 1 }
                update_vore_portrait_effect = yes
            }
        }
    }

    # Unbirth
    option = {
        name = prison_voreOpt.0001c
        trigger = {
            AND = {
                scope:predator = { is_female = yes }
                NOT = { scope:predator = { has_trait = pregnant } }
                global_var:unbirth_banned = no       
            }
        }
        ai_chance = {
            unbirth_vore_modifier = yes
        }
        trigger_event = prison_vore.0004 
        hidden_effect = {
            scope:predator = {
                change_variable = { name = num_prey add = 1 }
                update_vore_portrait_effect = yes
            }
        }
    }

    # Cock
    option = {
        name = prison_voreOpt.0001d
        trigger = {
            AND = {
                scope:predator = { is_female = no }
                global_var:cock_banned = no
            }
        }
        ai_chance = {
            cock_vore_modifier = yes
        }
        trigger_event = prison_vore.0005
        hidden_effect = {
            scope:predator = {
                change_variable = { name = num_prey add = 1 }
                update_vore_portrait_effect = yes
            }
        }
    }
        
    # Exit
    option = {
        name = prison_voreOpt.0001e
        hidden_effect = {
            exit_clean_up_effect = yes
        }
    }
}

# Oral Vore
prison_vore.0002 = {
    title = prison_voreTitle.0002
    type = character_event
    desc = prison_voreDesc.0002
    theme = dungeon

    left_portrait = {
        character = scope:predator
        animation = lunatic
    }

    # Fatal Digestion
    option = {
        name = prison_voreOpt.0004a
        trigger = { global_var:digestion_banned = no }
        ai_chance = {
            lethal_vore_modifier = { PREY = scope:prey }
        }
        # FIXED: Changed type from 'unbirth' to 'oral'
        lethal_vore_effect = {
            type = oral
        }
    }

    # Non-fatal
    option = {
        name = prison_voreOpt.0004c
        ai_chance = {
            safe_vore_modifier = { PREY = scope:prey }
        }
        safe_vore_effect = {
            type = oral
            prison_type = vore_dungeon
        }
        hidden_effect = {
            if = {
                limit = { is_ai = yes }
                trigger_event = { id = vore.0001 months = 3 }
            }
        }
    }

    after = {
        clean_up_effect = yes
    }
}

# Anal Vore
prison_vore.0003 = {
    title = prison_voreTitle.0003
    type = character_event
    desc = prison_voreDesc.0003
    theme = dungeon

    # Fatal
    option = {
        name = prison_voreOpt.0003a
        trigger = { global_var:digestion_banned = no }
        ai_chance = {
            lethal_vore_modifier = { PREY = scope:prey }
        }
        lethal_vore_effect = {
            type = anal
        }
    }

    # Non-fatal
    option = {
        name = prison_voreOpt.0003b
        ai_chance = {
            safe_vore_modifier = { PREY = scope:prey }
        }
        safe_vore_effect = {
            type = anal
            prison_type = vore_dungeon
        }
    }
    
    after = {
        clean_up_effect = yes
    }
}

# Unbirth
prison_vore.0004 = {
    title = prison_voreTitle.0004
    type = character_event
    desc = prison_voreDesc.0004
    theme = dungeon

    # Fatal Digestion
    option = {
        name = prison_voreOpt.0004a
        trigger = { global_var:digestion_banned = no }
        ai_chance = {
            lethal_vore_modifier = { PREY = scope:prey }
        }
        hidden_effect = {
            scope:predator = {
                add_character_modifier = { modifier = fertility_boost }
                trigger_event = { id = vore.0002 months = { 2 3 } }
            }        
            scope:prey = {
                death = { killer = scope:predator death_reason = death_execution_unbirth }
            }        
        }
    }

    # Rebirth/Transformation (Commented out as per your file)
    # option = { ... }

    # Non-fatal
    option = {
        name = prison_voreOpt.0004c
        ai_chance = {
            safe_vore_modifier = { PREY = scope:prey }
        }
        safe_vore_effect = {
            type = unbirth
            prison_type = vore_dungeon
        }
    }
    
    after = {
        # FIXED: Only trigger follow-up if prey survived (implied by safe_vore_effect)
        # We check if prey is alive to avoid triggering on the fatal option
        if = {
            limit = { scope:prey = { is_alive = yes } }
            trigger_event = { id = vore.0001 months = 3 }
        }
        clean_up_effect = yes
    }
}

# Cock Vore
prison_vore.0005 = {
    title = prison_voreTitle.0005
    type = character_event
    desc = prison_voreDesc.0005
    theme = dungeon

    immediate = {
        scope:predator = {
            add_character_flag = vore_predator   
        }
    }
    
    # Fatal
    option = {
        name = prison_voreOpt.0005a
        trigger = { global_var:digestion_banned = no }
        ai_chance = {
            lethal_vore_modifier = { PREY = scope:prey }
        }
        hidden_effect = {
            scope:predator = {
                add_character_modifier = { modifier = fertility_boost } 
                trigger_event = { id = vore.0002 months = { 2 3 } }
            }
            scope:prey = {
                death = { death_reason = death_execution_cock killer = scope:predator }
            }
        }
    }

    # Non-fatal
    option = {
        name = prison_voreOpt.0005b
        ai_chance = {
            safe_vore_modifier = { PREY = scope:prey }
        }
        safe_vore_effect = {
            type = cock
            prison_type = vore_dungeon
        }
    }
    
    after = {
        # FIXED: Check if prey is alive before triggering follow-up
        if = {
            limit = { scope:prey = { is_alive = yes } }
            trigger_event = { id = vore.0001 months = 5 }
        }
        clean_up_effect = yes
    }
}