random_orifice_vore_effect = {
    random_list = {
        # Safe Vore Branch
        50 = {
            safe_vore_modifier = { PREY = scope:prey }
            random_orifice_safe_vore_effect = { prison_type = $prison_type$ }
        }
        # Lethal Vore Branch
        50 = {
            trigger = { global_var:digestion_banned = no }
            lethal_vore_modifier = { PREY = scope:prey }
            random_orifice_lethal_vore_effect = yes
        }
    }
}

random_orifice_safe_vore_effect = {
    random_list = {
        25 = {
            trigger = { global_var:oral_banned = no }
            oral_vore_modifier = yes
            safe_vore_effect = {
                prison_type = $prison_type$
                type = oral
            }
        }
        25 = {
            trigger = { global_var:anal_banned = no }
            anal_vore_modifier = yes
            safe_vore_effect = {
                prison_type = $prison_type$
                type = anal
            }
        }
        25 = {
            trigger = {
                global_var:unbirth_banned = no
                is_female = yes
            }
            unbirth_vore_modifier = yes
            safe_vore_effect = {
                prison_type = $prison_type$
                type = unbirth
            }
        }
        25 = {
            trigger = {
                global_var:cock_banned = no
                is_female = no
            }
            cock_vore_modifier = yes
            safe_vore_effect = {
                prison_type = $prison_type$
                type = cock
            }
        }
        0 = {
            safe_vore_effect = {
                prison_type = $prison_type$
                type = oral
            }
        }
    }
}

random_orifice_lethal_vore_effect = {
    random_list = {
        25 = {
            trigger = { global_var:oral_banned = no }
            oral_vore_modifier = yes
            lethal_vore_effect = { type = oral }
            }
        25 = {
            trigger = { global_var:anal_banned = no }
            anal_vore_modifier = yes
            lethal_vore_effect = { type = anal }
        }
        25 = {
            trigger = {
                global_var:unbirth_banned = no
                is_female = yes
            }
            unbirth_vore_modifier = yes
            lethal_vore_effect = { type = unbirth }
        }
        25 = {
            trigger = {
                global_var:cock_banned = no
                is_female = no
            }
            cock_vore_modifier = yes
            lethal_vore_effect = { type = cock }
        }
        0 = {
            lethal_vore_effect = { type = oral }
        }
    }
}

# Non-lethal Vore
safe_vore_effect = {
    if = {
        limit = { NOT = { exists = scope:predator } }
        scope:actor = { save_scope_as = predator }
    }
    
    if = {
        limit = { NOT = { exists = scope:prey } }
        scope:recipient = { save_scope_as = prey }
    }

    else = {
        if = {
            limit = { scope:predator = { can_vore = yes } }
            
            scope:predator = {
                add_trait = $type$_predator
                add_character_flag = $type$_predator
                add_character_flag = vore_predator
                set_relation_prey = scope:prey
                add_relation_flag = {
                    flag = $type$
                    target = scope:prey
                    relation = prey
                }
                
                create_character_memory = { type = pred_non_fatal_memory participants = { prey = scope:prey } }
                
                # INCREMENT PREY COUNTER
                change_variable = { name = num_prey add = 1 }
                change_variable = { name = num_$type$_prey add = 1 }
                
                # Update Portrait/Belly immediately
                update_vore_portrait_effect = yes
            }
            
            # Imprisonment Logic
            if = {
                limit = {
                    scope:prey = {
                        OR = {
                            is_in_prison_type = dungeon
                            is_in_prison_type = house_arrest
                        }
                    }
                }
                scope:prey = { 
                    change_prison_type = $prison_type$
                    if = { limit = { is_in_prison_type = dungeon } add_character_flag = vored_from_dungeon }
                    if = { limit = { is_in_prison_type = house_arrest } add_character_flag = vored_from_house_arrest }
                }
            }
            else_if = {
                limit = {
                    scope:predator = {
                        is_ruler = yes
                    }
                }
                scope:predator = {
                    imprison = {
                        target = scope:prey
                        type = $prison_type$
                    }
                }
            }
            else_if = {
                limit = {
                    exists = scope:predator.liege
                }
                scope:predator.liege = {
                    imprison = {
                        target = scope:prey
                        type = $prison_type$
                    }
                }
            }
            
            # Prey Effects
            scope:prey = {
                add_character_modifier = { modifier = $type$_vored }
                add_character_flag = vored
                add_trait = $type$_vored
                create_character_memory = { type = prey_non_fatal_memory participants = { pred = scope:predator } }
                add_to_variable_list = {
                    name = prey_list
                    target = scope:predator
                }
                if = {
                    limit = { scope:predator = { is_ai = yes } }
                    create_story = vore_safe_story
                }
                # Initialize variable
                set_variable = { name = imprisonment_duration value = 0 }
            }
        }
    }
    
    # DEBUG NOTIFICATION
    hidden_effect = {
        if = {
            trigger_event = {
                id = vore_debug.0001
            }
        }
    }
}

lethal_vore_effect = {
    if = {
        limit = { NOT = { exists = scope:predator } }
        scope:actor = { save_scope_as = predator }
    }
    if = {
        limit = { NOT = { exists = scope:prey } }
        scope:recipient = { 
           save_scope_as = prey
           set_variable = { name = digestion_progress value = 0}
        }
    }

    if = {
        limit = { global_var:$type$_banned = yes }
        random_orifice_lethal_vore_effect = yes
    } 
    else = {

        # 2. PREDATOR STATE
        scope:predator = {
            change_variable = { name = num_prey add = 1 }
            change_variable = { name = num_$type$_prey add = 1 }
            add_trait = digesting
            add_character_flag = vore_predator
            update_vore_portrait_effect = yes
            add_character_flag = $type$_current_prey
            create_story = vore_digestion_story
        }

        # 1. PRE-DATA SAVING (On Prey)
        scope:prey = {          
            death = { 
                death_reason = death_execution_$type$
                killer = scope:predator
            }
        }
    }
}

# Check for all locations of vore for release
release_prey_location_check_effect = {
    if = {
        limit = { NOT = { exists = scope:prey } }
        root = { save_scope_as = prey }
    }

    if = {
        limit = { NOT = { exists = scope:predator } }
        random_relation = {
            type = predator
            save_scope_as = predator
        }
    }

    scope:prey = {
        switch = {
            trigger = has_trait
            
            oral_vored = {
                scope:predator = {
                    release_prey_effect = { 
                        type = oral 
                    }
                }
            }
        
            anal_vored = {
                scope:predator = {
                    release_prey_effect = { 
                        type = anal 
                    }
                }
            }
            
            # Case: Unbirth
            unbirth_vored = {
                scope:predator = {
                    release_prey_effect = { 
                        type = unbirth 
                    }
                }
            }
            
            # Case: Cock
            cock_vored = {
                scope:predator = {
                    release_prey_effect = { 
                        type = cock 
                    }
                }
            }
            
            # Fallback: If no trait found (Safety net)
            fallback = {
                scope:predator = {
                    release_prey_effect = { 
                        type = oral 
                    }
                }
            }
        }
    }
}

# Used to properly release prey (REVISED LOGIC)
release_prey_effect = {
    if = {
        limit = { AND = { NOT = { exists = scope:prey } has_character_flag = vored} }
        save_scope_as = prey
    }
    if = {
        limit = { AND = { NOT = { exists = scope:predator } has_character_flag = vore_predator } }
        random_relation = {
            type = predator
            save_scope_as = predator
        }
        scope:actor = { save_scope_as = predator }
    }

    # Ensure prey still exists
    if = {
        limit = { scope:prey = { is_alive = yes } }
    
        scope:predator = {
            change_variable = { name = num_prey add = -1 }
            change_variable = { name = num_$type$_prey add = -1 }
            
            # Check if there are OTHER prey of the same type.
            if = {
                limit = { scope:predator.var:num_$type$_prey <= 0 }
                remove_trait = $type$_predator
                remove_character_flag = $type$_predator
            }

            update_vore_portrait_effect = yes

            # If empty, remove generic flag
            if = {
                limit = { var:num_prey <= 0 }
                remove_character_flag = vore_predator
            }

            add_character_modifier = { modifier = satisfied years = 1 }
            remove_relation_prey = scope:prey
            remove_list_variable = {
                name = prey_list
                target = scope:prey
            }
        }

        scope:prey = {
            remove_character_flag = vored
            remove_character_modifier = $type$_vored
            remove_trait = $type$_vored
            
            if = {
                limit = { has_character_flag = vored_from_dungeon }
                change_prison_type = dungeon
                remove_character_flag = vored_from_dungeon   
            }
            else_if = {
                limit = { has_character_flag = vored_from_house_arrest }
                change_prison_type = house_arrest
                remove_character_flag = vored_from_house_arrest
            }
            else_if = {
                limit = { is_imprisoned = yes }
                release_from_prison = yes
            }
        }
    }
    
    hidden_effect = {
        if = {
            #limit = { global_var:debug_notifications = yes }
            trigger_event = {
                id = vore_debug.0002
            }
        }
    }
}

# Used when finishing digestion (Called from on_action)
finish_digesting_effect = {
    if = { 
        limit = { has_trait_rank = { trait = predator rank < 1 } }         
        add_trait = predator_1
    }
    else_if = { 
        limit = { has_trait_rank = { trait = predator rank = 1 } }
        change_trait_rank = { trait = predator rank = 2 }
    }
    else_if = { 
        limit = { has_trait_rank = { trait = predator rank >= 2 } }
        change_trait_rank = { trait = predator rank = 3 }
    }        
    
    # Cleanup
    #Add relations in case of multiple digesting prey
    if = {
        limit = {
            NOT = {
                any_relation = {
                    type = prey
                    owns_story_of_type = vore_digestion_story
                }
            }
        }
        if = { limit = { has_trait = digesting } remove_trait = digesting }
        if = { limit = { has_trait = genital_digesting } remove_trait = genital_digesting }
    }

    change_variable = { name = num_prey add = -1 }
    change_variable = { name = num_$type$_prey add = -1 }
    
    update_vore_portrait_effect = yes

    # Rewards
    random_list = {
        50 = { add_prowess_skill = 1 }
        50 = { add_diplomacy_skill = 1 }  
    }
    add_character_modifier = { modifier = satisfied years = 2 }
    change_current_weight = 30
    
    # If count is 0, remove the predator flag
    if = {
        limit = { var:num_prey <= 0 }
        remove_character_flag = vore_predator
    }
}	


# --- HELPER EFFECTS ---

# This effect updates the predator's portrait based on their current prey count.
update_vore_portrait_effect = {
    # # Clean state
    # remove_character_modifier = vore_belly_small
    # remove_character_modifier = vore_belly_medium
    # remove_character_modifier = vore_belly_large
    
    # # --- GIANT LOGIC ---
    # # Giants need more mass to show the same belly size as a normal human
    # if = {
    #     limit = {
        #         has_trait = giant
        #         var:num_prey >= 3
        #     }
        #     add_character_modifier = vore_belly_small
        # }
        # if = {
            #     limit = {
                #         has_trait = giant
                #         var:num_prey >= 7
                #     }
                #     add_character_modifier = vore_belly_medium
                # }
                # if = {
                    #     limit = {
                        #         has_trait = giant
                        #         var:num_prey >= 11
                        #     }
                        #     add_character_modifier = vore_belly_large
                        # }
                        
                        # # --- DWARF LOGIC ---
    # # Dwarfs fill up faster
    # else_if = {
        #     limit = {
            #         has_trait = dwarf
            #         var:num_prey >= 1
            #     }
            #     add_character_modifier = vore_belly_medium
            # }
            # if = {
                #     limit = {
                    #         has_trait = dwarf
                    #         var:num_prey >= 3
                    #     }
                    #     add_character_modifier = vore_belly_large
                    # }
                    
                    # # --- NORMAL LOGIC ---
                    # else_if = {
                        #     limit = {
                            #         var:num_prey >= 1
                            #         var:num_prey < 3
                            #     }
                            #     add_character_modifier = vore_belly_small
                            # }
                            # else_if = {
                                #     limit = {
                                    #         var:num_prey >= 3
                                    #         var:num_prey < 5
                                    #     }
                                    #     add_character_modifier = vore_belly_medium
                                    # }
                                    # else_if = {
                                        #     limit = {
                                            #         var:num_prey >= 5
                                            #     }
    #     add_character_modifier = vore_belly_large
    # }
}

# Simulates the appearance of vore without creating a victim (should do everything though, like add num_prey
simulate_npc_vore_effect = {
    # 1. Increment the "Prey Count" (This triggers the belly visual)
    change_variable = { name = num_prey add = 1 }
    
    # 2. Update the portrait immediately (Show the belly)
    
    add_character_flag = fake_vore_predator
    
    random_list = {
        # Oral
        25 = {
            oral_vore_modifier = yes
            trigger = { global_var:oral_banned = no }
            change_variable = { name = num_oral_prey add = 1 }
            add_trait = oral_predator
        }
        # Anal
        25 = {
            oral_vore_modifier = yes
            trigger = { global_var:anal_banned = no }
            change_variable = { name = num_anal_prey add = 1 }
            add_trait = anal_predator
        }
        # Unbirth
        25 = {
            unbirth_vore_modifier = yes
            trigger = {
                global_var:unbirth_banned = no
                is_female = yes
            }
            change_variable = { name = num_unbirth_prey add = 1 }
            add_trait = unbirth_predator
        }
        # Cock
        25 = {
            cock_vore_modifier = yes
            trigger = {
                global_var:cock_banned = no
                is_female = no
            }
            change_variable = { name = num_cock_prey add = 1 }
            add_trait = cock_predator
        }
    }
    update_vore_portrait_effect = yes
    
    # 6 months to 1 year later
    trigger_event = {
        id = vore.0020
        days = { 180 360 }
    }
}

# Removes Unnecessary Info
clean_up_effect = {
    if = {
        limit = { exists = scope:predator }
        scope:predator = {
            if = { limit = { has_character_flag = portrait_belly } remove_character_flag = portrait_belly }
            clear_saved_scope = predator
        }
    }
    if = {
        limit = { exists = scope:prey }
        scope:prey = {
            clear_saved_scope = prey
        }
    }
}

exit_clean_up_effect = {
    scope:predator = {
        clear_saved_scope = predator
    }
    scope:prey = {
        clear_saved_scope = prey       
    }   
}